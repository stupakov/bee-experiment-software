require 'sinatra'
require_relative '../lib/xml_to_csv_converter'

get '/' do
  erb :form
end

post '/' do
  return erb :error if params[:file].nil?
  input_filename = params[:file][:filename]
  unless input_filename.match /\.xml$/
    return erb :error
  end
  output_filename = input_filename.gsub(/xml$/, 'csv')

  tempfile = params[:file][:tempfile]
  datafile_contents = File.read(tempfile)

  content_type 'application/csv'
  attachment output_filename
  XmlToCsvConverter.new(datafile_contents).convert_to_csv
end

enable :inline_templates

__END__

@@ form
<p>
This application converts an XML file generated by a Maja RFID reader device into a CSV file.
</br>
Upload an XML file using the form below and click "Convert to CSV" to download the data in CSV format.
</p>

<form action="" method="post" enctype="multipart/form-data">
  <p>
    <label for="file">File:</label>
    <input type="file" name="file">
  </p>

  <p>
    <input name="commit" type="submit" value="Convert to CSV" />
  </p>
</form>

@@ error
<p>
ERROR: Input file must be an .xml file<br/>
Click back and try again.
</p>

